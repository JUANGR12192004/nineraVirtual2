{% extends 'web/base.html' %}

{% block title %}Dashboard | Niñera Virtual{% endblock %}

{% block content %}
<section class="dash-layout">
    <aside class="dash-sidebar">
        <section class="dash-panel">
            <h3>Fuentes de video</h3>
            <div class="dash-actions">
                <button id="btn-add-camera" class="dash-btn dash-btn--primary" type="button">📷 Agregar Cámara</button>
                <button id="btn-add-video" class="dash-btn dash-btn--primary" type="button">🎞️ Agregar Video</button>
                <button class="dash-btn dash-btn--danger" type="button">❌ Quitar Fuente</button>
            </div>
        </section>
        <section class="dash-panel">
            <h3>Cámaras activas</h3>
            <div class="dash-list dash-list--cameras">
                <p class="dash-empty">Aún no hay fuentes activas. Súbelas desde los botones superiores.</p>
            </div>
        </section>
        <section class="dash-panel" id="zonas">
            <h3>Zonas de riesgo</h3>
            <div class="dash-actions">
                <button class="dash-btn dash-btn--secondary" type="button">🏷️ Definir Zonas</button>
                <button class="dash-btn dash-btn--secondary" type="button">📂 Cargar Zonas (JSON)</button>
                <button class="dash-btn dash-btn--secondary" type="button">💾 Guardar Zonas (JSON)</button>
            </div>
        </section>
    </aside>

    <section class="dash-main">
        <header class="dash-main__header">
            <div>
                <h2>Vista en tiempo real</h2>
                <p>Selecciona una fuente para iniciar el monitoreo.</p>
            </div>
            <div class="dash-main__upload">
                <form method="post" action="{% url 'deteccion:upload' %}" enctype="multipart/form-data" class="dash-upload-form">
                    {% csrf_token %}
                    {{ upload_form.file }}
                    {{ upload_form.notes }}
                    <button type="submit">Procesar archivo</button>
                </form>
            </div>
        </header>
        <div class="dash-video">
            <p class="dash-video__placeholder">Niñera Virtual<br>Selecciona o agrega una fuente.</p>
        </div>
        <footer class="dash-status">Sistema listo.</footer>
    </section>

    <aside class="dash-right">
        <section class="dash-panel" id="historial">
            <h3>Alertas recientes</h3>
            <div class="dash-list dash-list--alerts">
                {% if alerts %}
                    {% for alert in alerts %}
                        <article class="dash-alert">
                            <header>
                                <h4>{{ alert.get_status_display }}</h4>
                                <span>{{ alert.uploaded_at|date:"d/m/Y H:i" }}</span>
                            </header>
                            <p>{{ alert.output_data|default:"Sin detalles" }}</p>
                        </article>
                    {% endfor %}
                {% else %}
                    <p class="dash-empty">Aún no hay alertas registradas.</p>
                {% endif %}
            </div>
        </section>
        <section class="dash-panel">
            <h3>Métricas</h3>
            <div class="dash-metrics">
                <div class="dash-metric"><span>📋Total</span><strong><strong id="m_total">{{ metrics.total }}</strong></strong></div>
                <div class="dash-metric"><span>🔪Cuchillo</span><strong><strong id="m_knife">{{ metrics.knife }}</strong></strong></div>
                <div class="dash-metric"><span>🪜Escaleras</span><strong><strong id="m_stairs">{{ metrics.stairs }}</strong></strong></div>
                <div class="dash-metric"><span>🔥Estufa</span><strong><strong id="m_stove">{{ metrics.stove }}</strong></strong></div>
                <div class="dash-metric"><span>🍲Olla</span><strong><strong id="m_pot">{{ metrics.pot }}</strong></strong></div>
                <div class="dash-metric"><span>📍Zonas</span><strong><strong id="m_zone">{{ metrics.zone }}</strong></strong></div>
                <div class="dash-metric"><span>⬆️Altura</span><strong><strong id="m_high">{{ metrics.high }}</strong></strong></div>
                <div class="dash-metric"><span>✂️Tijeras</span><strong><strong id="m_scissors">{{ metrics.scissors }}</strong></strong></div>
            </div>
        </section>
        <section class="dash-panel">
            <a class="dash-btn dash-btn--full" href="{% url 'deteccion:export_alerts_csv' %}" target="_blank" rel="noopener">⬇️ Exportar historial CSV</a>
        </section>
    </aside>
</section>
{% endblock %}



{% block extra_scripts %}
<script>
(function(){
  const fileInput = document.getElementById('upload_file_input');
  const btnVideo = document.getElementById('btn-add-video');
  const btnCam = document.getElementById('btn-add-camera');
  if (btnVideo && fileInput) btnVideo.addEventListener('click',()=>fileInput.click());

  const container = document.querySelector('.dash-video');
  let started = false, ws, sendCanvas, ctx, videoEl, overlay;

  async function startStreaming(){
    if (started) return; started = true;
    container.innerHTML = '<p class="dash-video__placeholder">Inicializando cámara...</p>';
    try {
      const stream = await navigator.mediaDevices.getUserMedia({video:true, audio:false});
      // UI
      container.style.position='relative';
      container.innerHTML='';
      videoEl = document.createElement('video');
      videoEl.autoplay = true; videoEl.muted = true; videoEl.playsInline = true; videoEl.style.maxWidth='100%';
      overlay = document.createElement('canvas'); overlay.style.position='absolute'; overlay.style.top='0'; overlay.style.left='0'; overlay.style.pointerEvents='none';
      container.appendChild(videoEl); container.appendChild(overlay);
      videoEl.srcObject = stream;

      // WS + envío
      ws = new WebSocket((location.protocol === 'https:' ? 'wss://' : 'ws://') + location.host + '/ws/stream');
      sendCanvas = document.createElement('canvas');
      ctx = sendCanvas.getContext('2d');

      function draw(items, srcW, srcH){
        const rect = videoEl.getBoundingClientRect();
        overlay.width = rect.width; overlay.height = rect.height;
        const o = overlay.getContext('2d'); o.clearRect(0,0,overlay.width,overlay.height);
        const sx = overlay.width / srcW; const sy = overlay.height / srcH;
        o.strokeStyle = '#20E3B2'; o.lineWidth = 2; o.font='12px Inter'; o.fillStyle='#20E3B2';
        (items||[]).forEach(d=>{ const [x1,y1,x2,y2]=d.box||[0,0,0,0]; o.strokeRect(x1*sx,y1*sy,(x2-x1)*sx,(y2-y1)*sy); o.fillText(`${d.label||''} ${(d.conf||0).toFixed(2)}`, x1*sx+2, y1*sy+12); });
      }

      ws.onopen = () => {
        const tick = () => {
          if (!videoEl || !videoEl.videoWidth) return;
          const targetW = 416; const targetH = Math.round(videoEl.videoHeight * (targetW / videoEl.videoWidth));
          sendCanvas.width = targetW; sendCanvas.height = targetH; ctx.drawImage(videoEl,0,0,targetW,targetH);
          const dataUrl = sendCanvas.toDataURL('image/jpeg', 0.6);
          ws.send(JSON.stringify({type:'frame', data:dataUrl, ts:Date.now(), w:targetW, h:targetH}));
        };
        setInterval(tick, 1000);
      };
      ws.onmessage = (ev) => {
        try {
          const msg = JSON.parse(ev.data);
          if (msg.type==='detections') {
            const items = msg.items||[]; draw(items, sendCanvas.width||416, sendCanvas.height||234);
            // métricas rápidas y alerta textual, usando 'over' del servidor (umbrales por clase)
            const banner = document.querySelector('.dash-status');
            const alertsBox = document.querySelector('.dash-list--alerts');
            const over = (msg.over && Array.isArray(msg.over)) ? msg.over : items;
            if (over.length && alertsBox) {
              const ts = new Date().toLocaleTimeString();
              const text = over.map(d=>`[${d.src}] ${d.label} ${d.conf.toFixed(2)}`).join(' · ');
              const art = document.createElement('article');
              art.className='dash-alert';
              art.innerHTML = `<header><h4>Procesado</h4><span>${ts}</span></header><p>${text}</p>`;
              alertsBox.prepend(art);
              while (alertsBox.children.length>8) alertsBox.removeChild(alertsBox.lastChild);
              if (banner){ banner.textContent = text; banner.style.background = '#DC2626'; banner.style.color = '#fff'; setTimeout(()=>{ banner.textContent='Sistema listo.'; banner.style.background=''; banner.style.color=''; }, 3500); }
              bumpMetrics(over);
            }
          }
        } catch {}
      };
      ws.onerror = () => { console.warn('WS error'); };
      ws.onclose = () => { console.warn('WS closed'); };
    } catch(e) {
      container.innerHTML = '<p class="dash-video__placeholder">No se pudo acceder a la cámara.</p>';
      console.warn('getUserMedia error:', e);
      started = false;
    }
  }

  if (btnCam) btnCam.addEventListener('click', startStreaming);
})();
</script>
<script>
(function(){
  // Soporte para reproducir un archivo de VIDEO local en el mismo área
  // y enviar frames por WebSocket igual que la cámara.
  const fileInput = document.getElementById('upload_file_input');
  const container = document.querySelector('.dash-video');
  if (!fileInput || !container) return;

  let ws, sendCanvas, ctx, videoEl, overlay, pushTimer;

  function cleanup(){
    if (pushTimer) { try{ clearInterval(pushTimer); }catch{} pushTimer=null; }
    try { if (ws && ws.readyState <= 1) ws.close(); } catch {}
    try { if (videoEl) { videoEl.pause(); if (videoEl.src && videoEl.src.startsWith('blob:')) URL.revokeObjectURL(videoEl.src); } } catch {}
  }

  function draw(items, srcW, srcH){
    if (!overlay || !videoEl) return;
    const rect = videoEl.getBoundingClientRect();
    overlay.width = rect.width; overlay.height = rect.height;
    const o = overlay.getContext('2d'); o.clearRect(0,0,overlay.width,overlay.height);
    const sx = overlay.width / (srcW||1); const sy = overlay.height / (srcH||1);
    const colorFor = (src)=> src==='custom' ? '#20E3B2' : '#F59E0B';
    o.lineWidth = 2; o.font='12px Inter';
    (items||[]).forEach(d=>{
      const b=d.box||[0,0,0,0]; const c=colorFor(d.src); o.strokeStyle=c; o.fillStyle=c;
      o.strokeRect(b[0]*sx,b[1]*sy,(b[2]-b[0])*sx,(b[3]-b[1])*sy);
      o.fillText(`${d.label||''} ${(d.conf||0).toFixed(2)}`,(b[0]*sx)+2,(b[1]*sy)+12);
    });
  }

  function bumpMetrics(items){
    const map = {
      knife: ['knife','cuchillo'],
      stove: ['kitchen','cocina','cooker','stove','horno','oven'],
      pot: ['pot','olla'],
      stairs: ['stairs','escalera'],
      scissors: ['scissors','tijera'],
    };
    const inc = {total:0, knife:0, stove:0, pot:0, stairs:0, scissors:0};
    items.forEach(d=>{
      const lbl=(d.label||'').toLowerCase();
      inc.total++;
      for (const k in map){ if (map[k].some(t=>lbl.includes(t))) inc[k]++; }
    });
    const add = (id,v)=>{ const el=document.getElementById(id); if(el){ const n=parseInt(el.textContent||'0',10)||0; el.textContent=String(n+v); } };
    add('m_total', inc.total); add('m_knife', inc.knife); add('m_stove', inc.stove); add('m_pot', inc.pot); add('m_stairs', inc.stairs); add('m_scissors', inc.scissors);
  }

  function startLocalVideo(file){
    cleanup();
    // UI
    container.style.position='relative';
    container.innerHTML='';
    videoEl = document.createElement('video');
    videoEl.autoplay = true; videoEl.muted = true; videoEl.playsInline = true; videoEl.style.maxWidth='100%';
    overlay = document.createElement('canvas'); overlay.style.position='absolute'; overlay.style.top='0'; overlay.style.left='0'; overlay.style.pointerEvents='none';
    container.appendChild(videoEl); container.appendChild(overlay);
    videoEl.src = URL.createObjectURL(file);
    videoEl.play().catch(()=>{});

    // WS + envío periódico
    ws = new WebSocket((location.protocol === 'https:' ? 'wss://' : 'ws://') + location.host + '/ws/stream');
    sendCanvas = document.createElement('canvas');
    ctx = sendCanvas.getContext('2d');
    ws.onopen = () => {
      pushTimer = setInterval(()=>{
        if (!videoEl || !videoEl.videoWidth) return;
        const targetW = 416; const targetH = Math.round(videoEl.videoHeight * (targetW / videoEl.videoWidth));
        sendCanvas.width = targetW; sendCanvas.height = targetH;
        ctx.drawImage(videoEl,0,0,targetW,targetH);
        const dataUrl = sendCanvas.toDataURL('image/jpeg', 0.6);
        try { ws && ws.readyState === 1 && ws.send(JSON.stringify({type:'frame', data:dataUrl, ts:Date.now(), w:targetW, h:targetH})); } catch {}
      }, 300);
    };
        ws.onmessage = (ev)=>{
      try{
        const m=JSON.parse(ev.data);
        if(m.type==='detections'){
          const items=m.items||[]; draw(items, sendCanvas.width||416, sendCanvas.height||234);
          const alertsBox=document.querySelector('.dash-list--alerts');
          const banner=document.querySelector('.dash-status');
          const over = (m.over && Array.isArray(m.over)) ? m.over : items;
          if(over.length && alertsBox){
            const ts = new Date().toLocaleTimeString();
            const text = over.map(d=>`[${d.src}] ${d.label} ${d.conf.toFixed(2)}`).join(' · ');
            const art = document.createElement('article');
            art.className='dash-alert';
            art.innerHTML = `<header><h4>Procesado</h4><span>${ts}</span></header><p>${text}</p>`;
            alertsBox.prepend(art);
            while (alertsBox.children.length>8) alertsBox.removeChild(alertsBox.lastChild);
            if (banner){ banner.textContent = text; banner.style.background = '#DC2626'; banner.style.color = '#fff'; setTimeout(()=>{ banner.textContent='Sistema listo.'; banner.style.background=''; banner.style.color=''; }, 3500); }
            bumpMetrics(over);
          }
        }
      }catch{}
    };
    ws.onerror = ()=>{ console.warn('WS error'); };
    ws.onclose = ()=>{ console.warn('WS closed'); };
  }

  fileInput.addEventListener('change', (e)=>{
    const f = e.target.files && e.target.files[0];
    if (!f) return;
    if (!/^video\//.test(f.type)) return; // solo reproducir si es video
    startLocalVideo(f);
  });
})();
</script>
<script>
(function(){
  const stopBtn = document.querySelector('.dash-sidebar .dash-panel .dash-actions .dash-btn--danger');
  if (!stopBtn) return;
  stopBtn.addEventListener('click', function(){
    try { window.stop && window.stop(); } catch(e) {}
    location.reload();
  });
})();
</script>
{% endblock %}





